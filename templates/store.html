<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Catalog</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .filter-btn.active { background-color: #2563eb; color: white; }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-10">
            <h1 id="store-title" class="text-4xl font-bold text-gray-800">Our Products</h1>
            <p class="text-gray-500 mt-2">THANK YOU FOR YOUR SUPPORT.</p>
        </header>

        <div class="mb-8 p-4 bg-white rounded-lg shadow-sm">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                <div class="md:col-span-2">
                    <label class="font-semibold text-gray-700">Filter by Type:</label>
                    <div id="filter-buttons" class="flex flex-wrap gap-2 mt-2">
                        </div>
                </div>
                <div>
                    <label for="search-input" class="font-semibold text-gray-700">Search by Item #:</label>
                    <input type="text" id="search-input" placeholder="Enter item number..." class="w-full mt-2 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <div id="loading" class="flex justify-center items-center h-64">
            <div class="loader"></div>
        </div>

        <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-8 hidden">
            </div>
        
        <div id="no-results-message" class="text-center text-gray-500 hidden py-16">
            <h3 class="text-2xl font-semibold">No Products Found</h3>
            <p>Please try adjusting your search or filter.</p>
        </div>
        
        <div id="error-message" class="text-center text-red-500 hidden"></div>
    </div>

    <footer class="text-center p-4 mt-10 text-sm text-gray-500 border-t">
        <div id="contacts-footer" class="flex justify-center items-center space-x-4 mb-2"></div>
        <p>Powered by HCL POS</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const productGrid = document.getElementById('product-grid');
            const loadingSpinner = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const filterButtonsContainer = document.getElementById('filter-buttons');
            const searchInput = document.getElementById('search-input');
            const noResultsMessage = document.getElementById('no-results-message');
            const storeTitle = document.getElementById('store-title');
            const contactsFooter = document.getElementById('contacts-footer');

            let allProducts = [];

            const pathParts = window.location.pathname.split('/');
            let userId = pathParts[pathParts.length - 1] || pathParts[pathParts.length - 2];

            if (!userId) {
                showError("No store ID provided in the URL.");
                return;
            }

            try {
                const cacheBuster = `?t=${new Date().getTime()}`;
                const response = await fetch(`/api/store/${userId}${cacheBuster}`);
                
                if (!response.ok) {
                    throw new Error(`Network response was not ok, status: ${response.status}`);
                }
                const data = await response.json();

                if (data.success) {
                    const settings = data.settings || {};
                    
                    storeTitle.textContent = settings.store_name || 'Our Products';
                    document.title = settings.store_name || 'Product Catalog';
                    renderContacts(settings.contacts);

                    if (data.products && data.products.length > 0) {
                        allProducts = data.products;
                        renderFilterButtons(allProducts);
                        filterAndRenderProducts();
                    } else {
                        loadingSpinner.style.display = 'none';
                        productGrid.classList.remove('hidden');
                        noResultsMessage.innerHTML = `<h3 class="text-2xl font-semibold">This store is getting set up!</h3><p>No products have been listed yet. Please check back later.</p>`;
                        noResultsMessage.classList.remove('hidden');
                    }
                } else {
                    showError(data.message || "Could not load store data.");
                }

            } catch (error) {
                console.error("Fetch Error:", error);
                showError("An error occurred while trying to fetch store data.");
            }

            searchInput.addEventListener('input', filterAndRenderProducts);

            function renderFilterButtons(products) {
                const types = new Set(products.map(p => p.product_type).filter(Boolean));
                filterButtonsContainer.innerHTML = '<button class="filter-btn active px-4 py-1.5 text-sm font-semibold border rounded-full hover:bg-blue-500 hover:text-white transition-colors" data-type="all">All</button>';
                types.forEach(type => {
                    const button = document.createElement('button');
                    button.className = "filter-btn px-4 py-1.5 text-sm font-semibold border rounded-full hover:bg-blue-500 hover:text-white transition-colors";
                    button.dataset.type = type;
                    button.textContent = type;
                    filterButtonsContainer.appendChild(button);
                });

                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelector('.filter-btn.active').classList.remove('active');
                        btn.classList.add('active');
                        filterAndRenderProducts();
                    });
                });
            }

            function filterAndRenderProducts() {
                const activeFilterType = document.querySelector('.filter-btn.active')?.dataset.type || 'all';
                const searchTerm = searchInput.value.toLowerCase();

                let filteredProducts = allProducts;

                if (activeFilterType !== 'all') {
                    filteredProducts = filteredProducts.filter(product => product.product_type === activeFilterType);
                }

                if (searchTerm) {
                    filteredProducts = filteredProducts.filter(product => product.item_number.toLowerCase().includes(searchTerm));
                }
                
                renderProducts(filteredProducts);
            }
            
            function renderProducts(products) {
                productGrid.innerHTML = '';
                
                if (products.length === 0 && allProducts.length > 0) {
                    noResultsMessage.innerHTML = `<h3 class="text-2xl font-semibold">No Products Found</h3><p>Please try adjusting your search or filter.</p>`;
                    noResultsMessage.classList.remove('hidden');
                } else if (products.length > 0) {
                    noResultsMessage.classList.add('hidden');
                }

                products.forEach(product => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md overflow-hidden flex flex-col';
                    
                    const placeholderImg = 'https://placehold.co/400x300/e5e7eb/6b7280?text=No+Image';
                    // Use image_urls array if available, otherwise fallback to single image_url
                    const images = product.image_urls && product.image_urls.length > 0 ? product.image_urls : [product.image_url];
                    const hasMultipleImages = images.length > 1;

                    // --- NEW: HTML structure for image slider ---
                    const imageSliderHTML = `
                        <div class="relative w-full h-48 bg-gray-100 product-image-slider">
                            ${images.filter(Boolean).map((url, index) => `
                                <img src="${url}" alt="${product.item_name}" class="absolute inset-0 w-full h-full object-contain transition-opacity duration-300 ${index === 0 ? 'opacity-100' : 'opacity-0'}" data-index="${index}">
                            `).join('')}
                            
                            ${hasMultipleImages ? `
                                <button class="slider-btn prev-btn absolute left-1 top-1/2 -translate-y-1/2 bg-black bg-opacity-40 text-white rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-opacity-60 z-10">&lt;</button>
                                <button class="slider-btn next-btn absolute right-1 top-1/2 -translate-y-1/2 bg-black bg-opacity-40 text-white rounded-full p-1 w-7 h-7 flex items-center justify-center hover:bg-opacity-60 z-10">&gt;</button>
                            ` : ''}
                        </div>
                    `;

                    card.innerHTML = `
                        ${imageSliderHTML}
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="text-lg font-semibold text-gray-800 truncate">${product.item_name}</h3>
                            <p class="text-sm text-gray-500 mb-2">Item #: ${product.item_number}</p>
                            <p class="text-xl font-bold text-blue-600 mt-auto">$${parseFloat(product.selling_price).toFixed(2)}</p>
                        </div>
                    `;
                    productGrid.appendChild(card);
                });
                
                loadingSpinner.style.display = 'none';
                productGrid.classList.remove('hidden');
            }

            // --- NEW: Event listener for all sliders on the page ---
            productGrid.addEventListener('click', (e) => {
                if (!e.target.classList.contains('slider-btn')) return;

                const isNext = e.target.classList.contains('next-btn');
                const slider = e.target.closest('.product-image-slider');
                const images = slider.querySelectorAll('img');
                if (images.length <= 1) return;

                let currentIndex = -1;
                images.forEach((img, index) => {
                    if (img.classList.contains('opacity-100')) {
                        currentIndex = index;
                    }
                });

                const nextIndex = isNext 
                    ? (currentIndex + 1) % images.length
                    : (currentIndex - 1 + images.length) % images.length;

                images[currentIndex].classList.remove('opacity-100');
                images[currentIndex].classList.add('opacity-0');
                images[nextIndex].classList.remove('opacity-0');
                images[nextIndex].classList.add('opacity-100');
            });


            function renderContacts(contacts) {
                contactsFooter.innerHTML = '';
                if (contacts && Array.isArray(contacts) && contacts.length > 0) {
                    contacts.forEach(contact => {
                        const link = document.createElement('a');
                        link.href = contact.url;
                        link.target = '_blank';
                        link.rel = 'noopener noreferrer';
                        link.className = 'text-blue-600 hover:underline font-semibold';
                        link.textContent = contact.name;
                        contactsFooter.appendChild(link);
                    });
                }
            }

            function showError(message) {
                loadingSpinner.style.display = 'none';
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>


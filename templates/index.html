<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HCL Jewelry POS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        #inventory-table { table-layout: fixed; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app-container" class="w-full h-full max-w-7xl mx-auto p-4 md:p-8 bg-white rounded-xl shadow-lg my-4">

        <div id="splash-screen" class="flex flex-col items-center justify-center min-h-[80vh]"> <div class="loader"></div> <p class="mt-4 text-gray-600">Loading Application...</p> </div>
        <div id="login-page" class="hidden flex-col items-center justify-center min-h-[80vh]">
            <div class="bg-white rounded-xl shadow-md p-8 max-w-md w-full">
                <img src="https://firebasestorage.googleapis.com/v0/b/posbyhcl.firebasestorage.app/o/ChatGPT%20Image%20Sep%209%2C%202025%2C%2012_10_15%20AM.png?alt=media&token=ab268580-23bf-4a83-8fa1-b74261101758" alt="HCL POS Logo" class="w-32 h-auto mx-auto mb-6">
                <h2 class="text-xl font-semibold text-gray-600 text-center mb-8">User Login</h2>
                <div class="mb-4"> <label for="email" class="block text-gray-700 font-medium mb-2">Email</label> <input type="email" id="email" autocomplete="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> </div>
                <div class="mb-6"> <label for="password" class="block text-gray-700 font-medium mb-2">Password</label> <input type="password" id="password" autocomplete="current-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"> </div>
                <p id="login-error" class="text-red-500 text-center mb-4 hidden"></p>
                <button id="login-button" class="w-full bg-blue-600 text-white font-semibold py-3 rounded-xl shadow-md hover:bg-blue-700 transition duration-300"> Enter </button>
                <p class="text-center text-sm text-gray-500 mt-6"> Need help? <a href="https://t.me/Hou_chheangly" target="_blank" rel="noopener noreferrer" class="font-medium text-blue-600 hover:underline">Contact Support</a> </p>
            </div>
        </div>
        <div id="main-menu" class="hidden flex-col items-center justify-center min-h-[80vh]">
            <img src="https://firebasestorage.googleapis.com/v0/b/posbyhcl.firebasestorage.app/o/ChatGPT%20Image%20Sep%209%2C%202025%2C%2012_10_15%20AM.png?alt=media&token=ab268580-23bf-4a83-8fa1-b74261101758" alt="HCL POS Logo" class="w-48 h-auto mx-auto mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-8">Main Menu</h1>

            <div class="flex flex-col space-y-4">
                <button id="stock-inventory-button" class="bg-blue-600 text-white font-semibold py-4 px-8 rounded-xl shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105"> Stock & Inventory </button>
                <button id="sales-button" class="bg-red-600 text-white font-semibold py-4 px-8 rounded-xl shadow-md hover:bg-red-700 transition duration-300 transform hover:scale-105"> Sale Dashboard </button>
                <button id="store-info-button" class="bg-purple-600 text-white font-semibold py-4 px-8 rounded-xl shadow-md hover:bg-purple-700 transition duration-300 transform hover:scale-105"> Store Information </button>
                <button id="sign-out-button" class="bg-gray-600 text-white font-semibold py-3 px-6 rounded-xl shadow-md hover:bg-gray-700 transition duration-300 mt-8"> Sign Out </button>
                <a href="https.me/Hou_chheangly" target="_blank" rel="noopener noreferrer" class="text-sm text-center text-gray-500 hover:text-gray-700 hover:underline mt-4"> Contact Support </a>
            </div>
        </div>

        <div id="store-info-page" class="hidden flex-col p-4">
            <div class="flex justify-between items-center mb-6">
                <button id="back-to-main-store-info" class="text-blue-600 hover:text-blue-800 transition duration-300">&lt; Back to Main Menu</button>
                <h1 class="text-3xl font-bold text-gray-800">Store Information</h1>
                <span></span> 
            </div>
            <div class="flex justify-center">
                <div class="p-6 bg-gray-50 rounded-xl shadow-sm w-full max-w-lg">
                    <div class="space-y-4">
                        <div>
                            <label for="store-name-input" class="block text-sm font-medium text-gray-600">Store Name</label>
                            <input type="text" id="store-name-input" placeholder="e.g., Ly's Jewelry Shop" class="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-600">Contact Methods</label>
                            <div id="contacts-container" class="mt-1 space-y-2"></div>
                            <div class="flex space-x-2 mt-2">
                                <input type="text" id="new-contact-name" placeholder="Contact Name (e.g., Facebook)" class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <input type="url" id="new-contact-url" placeholder="URL (e.g., https://...)" class="w-1/2 px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <button id="add-contact-button" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 text-sm">Add</button>
                            </div>
                        </div>
                    </div>
                    <button id="save-store-settings-button" class="w-full mt-6 bg-indigo-600 text-white font-semibold py-2.5 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">Save Store Information</button>
                </div>
            </div>
        </div>

        <div id="stock-page" class="hidden flex-col p-4">
            <div class="flex justify-between items-center mb-6"> <button id="back-to-main-stock" class="text-blue-600 hover:text-blue-800 transition duration-300">&lt; Back to Main Menu</button> <h1 class="text-3xl font-bold text-gray-800">Stock & Inventory Management</h1> <span></span> </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-gray-50 p-6 rounded-xl shadow-sm space-y-4">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Add/Edit Product</h2>
                    
                    <!-- NEW: Multi-image preview container -->
                    <label class="block text-sm font-medium text-gray-700">Images</label>
                    <div id="image-previews-container" class="grid grid-cols-3 gap-2 p-2 bg-gray-200 rounded-lg min-h-[80px]">
                        <!-- Image previews will be added here by JavaScript -->
                    </div>
                    
                    <!-- NEW: File input now accepts multiple files -->
                    <div> 
                        <input type="file" id="image-input" accept="image/*" multiple class="mt-1 w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"> 
                    </div>

                    <div> <label class="block text-sm font-medium text-gray-700">Item Number</label> <input type="text" id="item-number-input" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"> </div>
                    <div> <label class="block text-sm font-medium text-gray-700">Item Name</label> <input type="text" id="item-name-input" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"> </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Product Type</label>
                        <div class="flex items-center space-x-2 mt-1">
                            <select id="product-type-select" class="w-full px-3 py-2 border border-gray-300 rounded-md"></select>
                            <button id="manage-types-button" class="px-3 py-2 bg-gray-600 text-white rounded-md text-sm hover:bg-gray-700">Manage</button>
                        </div>
                    </div>
                    <div> <label class="block text-sm font-medium text-gray-700">Quantity</label> <input type="number" id="quantity-input" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"> </div>
                    <div> <label class="block text-sm font-medium text-gray-700">Import Price</label> <input type="number" id="import-price-input" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"> </div>
                    <div> <label class="block text-sm font-medium text-gray-700">Selling Price</label> <input type="number" id="selling-price-input" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md"> </div>
                    <button id="add-update-product-button" class="w-full bg-blue-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-blue-700">Add Item</button>
                    <button id="clear-product-fields-button" class="w-full bg-gray-400 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-gray-500">Clear Fields</button>
                    <button id="generate-pdf-button" class="w-full bg-green-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-green-700">Generate PDF Report</button>
                    <button id="generate-store-link-button" class="w-full mt-2 bg-purple-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-purple-700">Get Sharable Store Link</button>
                </div>
                <div class="md:col-span-2">
                    <div class="overflow-x-auto bg-white p-4 rounded-xl">
                        <table id="inventory-table" class="min-w-full">
                            <thead> <tr> <th class="py-2 px-4 w-20">Image</th> <th class="py-2 px-4">Item #</th> <th class="py-2 px-4">Name</th> <th class="py-2 px-4">Type</th> <th class="py-2 px-4">Qty</th> <th class="py-2 px-4">Price</th> <th class="py-2 px-4">Actions</th> </tr> </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="pagination-controls" class="mt-4 flex justify-between items-center">
                        <button id="prev-page-button" class="bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-gray-400 disabled:opacity-50"> &lt; Previous </button>
                        <span id="page-info"></span>
                        <button id="next-page-button" class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-sm hover:bg-blue-700 disabled:opacity-50"> Next &gt; </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="sales-page" class="hidden flex-col p-4">
             <div class="flex justify-between items-center mb-6"> <button id="back-to-main-sales" class="text-blue-600 hover:text-blue-800 transition duration-300">&lt; Back to Main Menu</button> <h1 class="text-3xl font-bold text-gray-800">Sales Dashboard</h1> <span></span> </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 bg-gray-50 p-6 rounded-xl shadow-sm space-y-4 flex flex-col">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">New Sale (Shopping Cart)</h2>
                    <div class="space-y-2"> <label class="block text-sm font-medium text-gray-700">Add Product to Cart</label> <select id="sale-product-select" class="w-full px-3 py-2 border border-gray-300 rounded-md"></select> </div>
                    <div class="space-y-2"> <label class="block text-sm font-medium text-gray-700">Selling Price (Discount)</label> <input type="number" id="sale-price-input" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Auto-fills from product"> </div>
                    <div class="flex items-center space-x-2"> <button id="add-to-cart-button" class="w-full bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600">Add to Cart</button> </div>
                    <div id="cart-items-container" class="flex-grow overflow-y-auto border-t border-b py-2 space-y-2"></div>
                    <div class="border-t pt-4 space-y-2">
                        <div class="flex justify-between font-bold text-lg"> <span>Total:</span> <span id="cart-total">$0.00</span> </div>
                        <button id="record-sale-button" class="w-full bg-red-600 text-white font-semibold py-2 rounded-lg shadow-md hover:bg-red-700 disabled:opacity-50" disabled>Record Sale</button>
                    </div>
                </div>
                <div class="md:col-span-2">
                    <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                        <div class="flex items-center space-x-4 mb-4">
                            <div> <label for="filter-date" class="block text-sm font-medium text-gray-700">Filter by Day</label> <input type="date" id="filter-date" class="mt-1 px-3 py-2 border border-gray-300 rounded-md"> </div>
                            <div> <label for="filter-month" class="block text-sm font-medium text-gray-700">Filter by Month</label> <input type="month" id="filter-month" class="mt-1 px-3 py-2 border border-gray-300 rounded-md"> </div>
                            <button id="filter-sales-button" class="self-end bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700">Filter</button>
                            <button id="clear-filter-button" class="self-end bg-gray-400 text-white px-4 py-2 rounded-md hover:bg-gray-500">Clear</button>
                        </div>
                        <div id="sales-summary" class="bg-gray-100 p-4 rounded-lg flex justify-around hidden">
                            <div> <h3 class="text-sm font-medium text-gray-500">Total Sales</h3> <p id="summary-total-sales" class="text-2xl font-semibold text-gray-800">$0.00</p> </div>
                            <div> <h3 class="text-sm font-medium text-green-600">Total Profit</h3> <p id="summary-total-profit" class="text-2xl font-semibold text-green-700">$0.00</p> </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto bg-white p-4 rounded-xl shadow-sm">
                        <table id="sales-table" class="min-w-full">
                            <thead> <tr> <th class="py-2 px-4">Date</th> <th class="py-2 px-4">Items Sold</th> <th class="py-2 px-4">Total Sale</th> <th class="py-2 px-4">Actions</th> </tr> </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="custom-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-sm mx-auto transform scale-95"> <div id="modal-body-content"> <h3 id="modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-2">Modal Title</h3> <p id="modal-message" class="text-sm text-gray-600 mb-4">Modal message goes here.</p> </div> <div id="modal-loading-content" class="hidden flex-col items-center"> <div class="loader"></div> <p id="modal-loading-message" class="mt-4 text-gray-600">Loading...</p> </div> <div id="modal-actions" class="flex justify-end space-x-2 mt-4"> <button id="modal-cancel" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button> <button id="modal-confirm" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Confirm</button> </div> </div>
    </div>
    
    <div id="manage-types-modal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden opacity-0">
        <div class="modal-content bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-auto transform scale-95">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Manage Product Types</h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Add New Type</label>
                <div class="flex space-x-2">
                    <input type="text" id="new-type-name-input" placeholder="e.g., Bracelets" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    <button id="add-type-button" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-md hover:bg-blue-700">Add</button>
                </div>
                <p id="type-error-message" class="text-red-500 text-sm mt-1 hidden"></p>
            </div>
            <div class="border-t pt-4">
                <h4 class="text-lg font-medium text-gray-700 mb-2">Existing Types</h4>
                <div id="existing-types-list" class="space-y-2 max-h-60 overflow-y-auto"></div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="close-types-modal-button" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Close</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBhfK39oamAG5WNlS_vDYJOIfEDOtke3Oc",
                authDomain: "posbyhcl.firebaseapp.com",
                projectId: "posbyhcl",
                storageBucket: "posbyhcl.firebasestorage.app",
                messagingSenderId: "139502289263",
                appId: "1:139502289263:web:c5c7f5e7492c72228ae89a",
                measurementId: "G-H1419P725S"
            };

            firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            
            // --- NEW: State variable to manage images for the product being edited ---
            let productImages = {
                existingUrls: [], // URLs from the database
                newFiles: []      // New files selected by the user
            };

            const state = { products: [], sales: [], currentPage: 'splash-screen', editingProduct: null, idToken: null, uid: null, pagination: { currentPage: 1, lastDocId: null, history: [null] }, cart: [], storeSettings: { contacts: [] } };
            const pages = { 'splash-screen': document.getElementById('splash-screen'), 'login-page': document.getElementById('login-page'), 'main-menu': document.getElementById('main-menu'), 'stock-page': document.getElementById('stock-page'), 'sales-page': document.getElementById('sales-page'), 'store-info-page': document.getElementById('store-info-page') };
            const modal = { element: document.getElementById('custom-modal'), content: document.getElementById('custom-modal').querySelector('.modal-content'), bodyContent: document.getElementById('modal-body-content'), loadingContent: document.getElementById('modal-loading-content'), title: document.getElementById('modal-title'), message: document.getElementById('modal-message'), loadingMessage: document.getElementById('modal-loading-message'), actions: document.getElementById('modal-actions'), confirmBtn: document.getElementById('modal-confirm'), cancelBtn: document.getElementById('modal-cancel') };
            const typesModal = { element: document.getElementById('manage-types-modal'), content: document.getElementById('manage-types-modal').querySelector('.modal-content'), closeBtn: document.getElementById('close-types-modal-button'), addBtn: document.getElementById('add-type-button'), input: document.getElementById('new-type-name-input'), list: document.getElementById('existing-types-list'), error: document.getElementById('type-error-message')};

            const showModal = (title, message, onConfirm, showCancel = true) => { modal.title.textContent = title; modal.message.innerHTML = message; modal.confirmBtn.onclick = () => { if (onConfirm) { onConfirm(); } hideModal(); }; modal.cancelBtn.textContent = 'Cancel'; modal.cancelBtn.style.display = showCancel ? 'block' : 'none'; modal.actions.style.display = 'flex'; modal.bodyContent.style.display = 'block'; modal.loadingContent.style.display = 'none'; modal.element.classList.remove('hidden'); setTimeout(() => { modal.element.classList.remove('opacity-0'); modal.content.classList.remove('scale-95'); }, 10); };
            const showLoadingModal = (message = "Please wait...") => { modal.loadingMessage.textContent = message; modal.bodyContent.style.display = 'none'; modal.actions.style.display = 'none'; modal.loadingContent.style.display = 'flex'; modal.element.classList.remove('hidden'); setTimeout(() => { modal.element.classList.remove('opacity-0'); modal.content.classList.remove('scale-95'); }, 10); };
            const hideModal = () => { modal.element.classList.add('opacity-0'); modal.content.classList.add('scale-95'); setTimeout(() => modal.element.classList.add('hidden'), 300); };
            modal.cancelBtn.addEventListener('click', hideModal);

            const showTypesModal = () => { typesModal.element.classList.remove('hidden'); refreshTypesModalList(); setTimeout(() => { typesModal.element.classList.remove('opacity-0'); typesModal.content.classList.remove('scale-95'); }, 10); };
            const hideTypesModal = () => { typesModal.element.classList.add('opacity-0'); typesModal.content.classList.add('scale-95'); setTimeout(() => { typesModal.element.classList.add('hidden'); typesModal.error.classList.add('hidden'); }, 300); };
            typesModal.closeBtn.addEventListener('click', hideTypesModal);

            const showPage = (pageName) => { Object.values(pages).forEach(page => { page.classList.add('hidden'); page.style.display = 'none'; }); pages[pageName].classList.remove('hidden'); pages[pageName].style.display = 'flex'; if (pageName !== 'login-page' && pageName !== 'splash-screen') { sessionStorage.setItem('posCurrentPage', pageName); } };
            const getAuthHeaders = () => ({ 'Authorization': `Bearer ${state.idToken}`, 'Content-Type': 'application/json' });
            
            const api = {
                getProducts: (startAfterId = null) => fetch(`/api/products?limit=20${startAfterId ? `&start_after=${startAfterId}` : ''}`, { headers: getAuthHeaders() }).then(res => res.json()),
                getAllProducts: () => fetch('/api/products', { headers: getAuthHeaders() }).then(res => res.json()),
                addUpdateProduct: (formData) => fetch('/api/products', { method: 'POST', headers: { 'Authorization': `Bearer ${state.idToken}` }, body: formData }).then(res => res.json()),
                deleteProduct: (itemNumber) => fetch(`/api/products/${itemNumber}`, { method: 'DELETE', headers: getAuthHeaders() }).then(res => res.json()),
                getSales: (date, month) => { let url = '/api/sales'; if (date) { url += `?date=${date}`; } else if (month) { url += `?month=${month}`; } return fetch(url, { headers: getAuthHeaders() }).then(res => res.json()); },
                recordSale: (cart) => fetch('/api/sales', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ items: cart }) }).then(res => res.json()),
                deleteSale: (saleId) => fetch(`/api/sales/${saleId}`, { method: 'DELETE', headers: getAuthHeaders() }).then(res => res.json()),
                generatePdf: async () => { const response = await fetch('/api/generate-pdf', { headers: getAuthHeaders() }); return response.blob(); },
                getTypes: () => fetch('/api/types', { headers: getAuthHeaders() }).then(res => res.json()),
                addType: (name) => fetch('/api/types', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify({ name }) }).then(res => res.json()),
                deleteType: (typeId) => fetch(`/api/types/${typeId}`, { method: 'DELETE', headers: getAuthHeaders() }).then(res => res.json()),
                getStoreSettings: () => fetch('/api/store/settings', { headers: getAuthHeaders() }).then(res => res.json()),
                updateStoreSettings: (settings) => fetch('/api/store/settings', { method: 'POST', headers: getAuthHeaders(), body: JSON.stringify(settings) }).then(res => res.json()),
            };

            auth.onAuthStateChanged(async (user) => { 
                if (user) { 
                    state.idToken = await user.getIdToken();
                    state.uid = user.uid;
                    const savedPage = sessionStorage.getItem('posCurrentPage');
                    if (savedPage && pages[savedPage]) {
                        showPage(savedPage);
                        if (savedPage === 'stock-page') { await refreshInventoryData(); await populateTypesDropdown(); } 
                        else if (savedPage === 'sales-page') { await refreshSalesData(); }
                    } else { 
                        showPage('main-menu'); 
                    }
                } else { 
                    state.idToken = null; state.uid = null;
                    sessionStorage.removeItem('posCurrentPage');
                    showPage('login-page'); 
                } 
            });

            // --- NEW: Function to render image previews ---
            const renderImagePreviews = () => {
                const container = document.getElementById('image-previews-container');
                container.innerHTML = ''; // Clear existing previews

                // Render existing images with a delete button
                productImages.existingUrls.forEach((url, index) => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative';
                    imgContainer.innerHTML = `
                        <img src="${url}" class="w-full h-20 object-cover rounded">
                        <button data-url="${url}" class="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs font-bold remove-existing-img-btn">&times;</button>
                    `;
                    container.appendChild(imgContainer);
                });

                // Render previews for new files selected
                productImages.newFiles.forEach(file => {
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'relative';
                    imgContainer.innerHTML = `<img src="${URL.createObjectURL(file)}" class="w-full h-20 object-cover rounded">`;
                    container.appendChild(imgContainer);
                });
            };
            
            const clearProductFields = () => { 
                document.getElementById('item-number-input').value = ''; 
                document.getElementById('item-name-input').value = '';
                document.getElementById('product-type-select').value = '';
                document.getElementById('quantity-input').value = ''; 
                document.getElementById('import-price-input').value = ''; 
                document.getElementById('selling-price-input').value = ''; 
                document.getElementById('image-input').value = ''; 
                document.getElementById('item-number-input').disabled = false; 
                document.getElementById('add-update-product-button').textContent = 'Add Item'; 
                state.editingProduct = null; 
                // Reset image state
                productImages = { existingUrls: [], newFiles: [] };
                renderImagePreviews();
            };

            const populateTypesDropdown = async (selectedValue = null) => {
                const result = await api.getTypes();
                const selectEl = document.getElementById('product-type-select');
                selectEl.innerHTML = '<option value="">Select a Type</option>';
                if (result.success) { result.types.forEach(type => { const option = document.createElement('option'); option.value = type.name; option.textContent = type.name; selectEl.appendChild(option); }); if (selectedValue) selectEl.value = selectedValue; }
            };
            const refreshTypesModalList = async () => {
                const result = await api.getTypes();
                typesModal.list.innerHTML = '';
                if (result.success && result.types.length > 0) { result.types.forEach(type => { const item = document.createElement('div'); item.className = 'flex justify-between items-center bg-gray-100 p-2 rounded'; item.innerHTML = `<span>${type.name}</span> <button data-id="${type.id}" class="delete-type-btn text-red-500 hover:text-red-700 text-sm font-semibold">Delete</button>`; typesModal.list.appendChild(item); }); } else { typesModal.list.innerHTML = '<p class="text-gray-500">No types created yet.</p>'; }
            };

            const updatePaginationControls = (hasNextPage) => { document.getElementById('prev-page-button').disabled = state.pagination.currentPage <= 1; document.getElementById('next-page-button').disabled = !hasNextPage; document.getElementById('page-info').textContent = `Page ${state.pagination.currentPage}`; };
            
            const renderInventoryTable = (products) => { 
                const tableBody = document.querySelector('#inventory-table tbody'); 
                tableBody.innerHTML = ''; 
                (products || []).forEach(product => { 
                    const row = document.createElement('tr');
                    // Display the first image in the table
                    const firstImage = (product.image_urls && product.image_urls.length > 0) ? product.image_urls[0] : (product.image_url || 'https://placehold.co/50x50/e5e7eb/6b7280?text=N/A');
                    row.innerHTML = ` 
                        <td class="py-2 px-4"><img src="${firstImage}" alt="${product.item_name}" class="w-12 h-12 object-cover rounded"></td> 
                        <td class="py-2 px-4">${product.item_number}</td> <td class="py-2 px-4">${product.item_name}</td> 
                        <td class="py-2 px-4">${product.product_type || 'N/A'}</td> <td class="py-2 px-4">${product.quantity}</td> 
                        <td class="py-2 px-4">$${parseFloat(product.selling_price).toFixed(2)}</td> 
                        <td class="py-2 px-4"> <button class="text-blue-600 hover:text-blue-800 mr-2 edit-product" data-item-number="${product.item_number}">Edit</button> <button class="text-red-600 hover:text-red-800 delete-product" data-item-number="${product.item_number}">Delete</button> </td>`; 
                    tableBody.appendChild(row); 
                }); 
            };

            const refreshInventoryData = async (direction = 'first') => {
                let startAfterId = null;
                if (direction === 'next') { startAfterId = state.pagination.lastDocId; state.pagination.currentPage++; } 
                else if (direction === 'prev') { state.pagination.currentPage--; startAfterId = state.pagination.history[state.pagination.currentPage - 1]; } 
                else { state.pagination = { currentPage: 1, lastDocId: null, history: [null] }; startAfterId = null; }
                const data = await api.getProducts(startAfterId);
                state.products = data.products;
                if(data.products.length > 0) state.pagination.lastDocId = data.products[data.products.length - 1].item_number;
                renderInventoryTable(data.products);
                updatePaginationControls(data.has_next);
            };
            
            const renderCart = () => { const cartContainer = document.getElementById('cart-items-container'); const cartTotalEl = document.getElementById('cart-total'); const recordSaleBtn = document.getElementById('record-sale-button'); cartContainer.innerHTML = ''; let total = 0; if (state.cart.length === 0) { cartContainer.innerHTML = '<p class="text-gray-500 text-center">Your cart is empty.</p>'; recordSaleBtn.disabled = true; } else { state.cart.forEach((item, index) => { const itemEl = document.createElement('div'); itemEl.className = 'flex items-center justify-between text-sm p-2 bg-white rounded-md'; itemEl.innerHTML = `<div><p class="font-semibold">${item.item_name}</p><p class="text-gray-600">$${parseFloat(item.selling_price).toFixed(2)} x ${item.quantity}</p></div><button class="text-red-500 hover:text-red-700 remove-from-cart" data-index="${index}">X</button>`; cartContainer.appendChild(itemEl); total += parseFloat(item.selling_price) * item.quantity; }); recordSaleBtn.disabled = false; } cartTotalEl.textContent = `$${total.toFixed(2)}`; };
            const addToCart = () => { const selectEl = document.getElementById('sale-product-select'); const priceEl = document.getElementById('sale-price-input'); const product = state.products.find(p => p.item_number === selectEl.value); if (product) { const existingCartItem = state.cart.find(item => item.item_number === selectEl.value); if (existingCartItem) existingCartItem.quantity++; else { const selling_price = parseFloat(priceEl.value) > 0 ? parseFloat(priceEl.value) : product.selling_price; state.cart.push({ ...product, quantity: 1, selling_price: selling_price }); } renderCart(); } selectEl.value = ''; priceEl.value = ''; };
            const refreshSalesData = async (date = null, month = null) => { const [allProductsData, salesData] = await Promise.all([ api.getAllProducts(), api.getSales(date, month) ]); state.products = allProductsData.products; state.sales = salesData.sales; renderProductOptions(); renderSalesTable(); const salesSummaryEl = document.getElementById('sales-summary'); if (state.sales.length > 0) { const totalSales = state.sales.reduce((acc, sale) => acc + sale.total_amount, 0); document.getElementById('summary-total-sales').textContent = `$${totalSales.toFixed(2)}`; document.getElementById('summary-total-profit').textContent = `$${salesData.total_profit.toFixed(2)}`; salesSummaryEl.classList.remove('hidden'); } else { salesSummaryEl.classList.add('hidden'); } };
            const renderProductOptions = () => { const selectEl = document.getElementById('sale-product-select'); selectEl.innerHTML = '<option value="">Select a product</option>'; [...(state.products || [])].sort((a, b) => a.item_name.localeCompare(b.item_name)).forEach(product => { const option = document.createElement('option'); option.value = product.item_number; option.textContent = `${product.item_name} (Stock: ${product.quantity})`; selectEl.appendChild(option); }); };
            const renderSalesTable = () => { const tableBody = document.querySelector('#sales-table tbody'); tableBody.innerHTML = ''; (state.sales || []).forEach(sale => { const row = document.createElement('tr'); const itemsHtml = sale.items.map(item => `<li>${item.quantity} x ${item.item_name} @ $${parseFloat(item.selling_price).toFixed(2)}</li>`).join(''); row.innerHTML = `<td class="py-2 px-4">${new Date(sale.timestamp * 1000).toLocaleDateString()}</td><td class="py-2 px-4 text-sm"><ul>${itemsHtml}</ul></td><td class="py-2 px-4 font-bold">$${sale.total_amount.toFixed(2)}</td><td class="py-2 px-4"> <button class="text-red-600 hover:text-red-800 delete-sale" data-sale-id="${sale.id}">Delete</button> </td>`; tableBody.appendChild(row); }); };
            const updateSalePriceInput = () => { const selectEl = document.getElementById('sale-product-select'); const priceEl = document.getElementById('sale-price-input'); const product = state.products.find(p => p.item_number === selectEl.value); priceEl.value = product ? product.selling_price : ''; };
            const loadStoreSettings = async () => { const result = await api.getStoreSettings(); if (result.success && result.settings) { state.storeSettings = result.settings; if (!Array.isArray(state.storeSettings.contacts)) { state.storeSettings.contacts = []; } } else { state.storeSettings = { store_name: '', contacts: [] }; } document.getElementById('store-name-input').value = state.storeSettings.store_name || ''; renderContacts(); };
            const renderContacts = () => { const container = document.getElementById('contacts-container'); container.innerHTML = ''; (state.storeSettings.contacts || []).forEach((contact, index) => { const el = document.createElement('div'); el.className = 'flex items-center justify-between text-sm bg-white p-2 rounded-md border'; el.innerHTML = `<div><span class="font-semibold">${contact.name}</span>: <a href="${contact.url}" target="_blank" class="text-blue-600 hover:underline">${contact.url}</a></div><button data-index="${index}" class="remove-contact-btn text-red-500 hover:text-red-700 font-bold">X</button>`; container.appendChild(el); }); };

            // --- Event Listeners ---
            document.getElementById('login-button').addEventListener('click', () => { auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(error => { document.getElementById('login-error').textContent = error.message; document.getElementById('login-error').classList.remove('hidden'); }); });
            document.getElementById('sign-out-button').addEventListener('click', () => auth.signOut());
            document.getElementById('stock-inventory-button').addEventListener('click', async () => { showPage('stock-page'); await refreshInventoryData(); await populateTypesDropdown(); });
            document.getElementById('sales-button').addEventListener('click', () => { showPage('sales-page'); refreshSalesData(); state.cart = []; renderCart(); });
            document.getElementById('store-info-button').addEventListener('click', async () => { showPage('store-info-page'); await loadStoreSettings(); });
            document.getElementById('back-to-main-stock').addEventListener('click', () => showPage('main-menu'));
            document.getElementById('back-to-main-sales').addEventListener('click', () => showPage('main-menu'));
            document.getElementById('back-to-main-store-info').addEventListener('click', () => showPage('main-menu'));
            
            document.getElementById('add-update-product-button').addEventListener('click', async () => { 
                const formData = new FormData(); 
                formData.append('item_number', document.getElementById('item-number-input').value.trim()); 
                formData.append('item_name', document.getElementById('item-name-input').value.trim()); 
                formData.append('product_type', document.getElementById('product-type-select').value);
                formData.append('quantity', document.getElementById('quantity-input').value.trim()); 
                formData.append('import_price', document.getElementById('import-price-input').value.trim()); 
                formData.append('selling_price', document.getElementById('selling-price-input').value.trim()); 
                
                // --- NEW: Append new files and existing URLs ---
                productImages.newFiles.forEach(file => {
                    formData.append('images', file); // 'images' must match getlist key in backend
                });
                formData.append('existing_image_urls', JSON.stringify(productImages.existingUrls));
                
                const result = await api.addUpdateProduct(formData); 
                if (result.success) { showModal('Success', result.message, () => { refreshInventoryData(); clearProductFields(); }, false); } 
                else { showModal('Error', result.message, null, false); } 
            });

            document.getElementById('clear-product-fields-button').addEventListener('click', clearProductFields);
            document.getElementById('generate-pdf-button').addEventListener('click', async () => { showLoadingModal("Generating PDF report..."); try { const blob = await api.generatePdf(); if (blob.type === 'application/pdf') { const url = window.URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'stock_report.pdf'; document.body.appendChild(a); a.click(); a.remove(); window.URL.revokeObjectURL(url); hideModal(); } else { const err = await blob.text(); showModal('Error', JSON.parse(err).message, null, false); } } catch (e) { showModal('Error', 'Failed to generate PDF.', null, false); } });
            
            // --- NEW: Updated image input listener ---
            document.getElementById('image-input').addEventListener('change', (event) => {
                // When new files are selected, they become the new "new files" list
                productImages.newFiles = Array.from(event.target.files);
                renderImagePreviews();
            });

            // --- NEW: Listener for removing existing images ---
            document.getElementById('image-previews-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-existing-img-btn')) {
                    const urlToRemove = e.target.dataset.url;
                    productImages.existingUrls = productImages.existingUrls.filter(url => url !== urlToRemove);
                    renderImagePreviews();
                }
            });

            document.getElementById('inventory-table').addEventListener('click', e => { 
                if (e.target.classList.contains('edit-product')) { 
                    const itemNumber = e.target.dataset.itemNumber; 
                    const product = state.products.find(p => p.item_number === itemNumber); 
                    if (product) { 
                        document.getElementById('item-number-input').value = product.item_number; 
                        document.getElementById('item-name-input').value = product.item_name; 
                        document.getElementById('product-type-select').value = product.product_type || '';
                        document.getElementById('quantity-input').value = product.quantity; 
                        document.getElementById('import-price-input').value = product.import_price; 
                        document.getElementById('selling-price-input').value = product.selling_price; 
                        document.getElementById('item-number-input').disabled = true; 
                        document.getElementById('add-update-product-button').textContent = 'Update Item'; 
                        state.editingProduct = product; 
                        // --- NEW: Populate image previews for editing ---
                        productImages.existingUrls = product.image_urls || (product.image_url ? [product.image_url] : []);
                        productImages.newFiles = [];
                        renderImagePreviews();
                    } 
                } else if (e.target.classList.contains('delete-product')) { 
                    const itemNumber = e.target.dataset.itemNumber; 
                    showModal('Delete Product', `Are you sure you want to delete '${itemNumber}'? This will delete all associated images and sales records.`, async () => { await api.deleteProduct(itemNumber); refreshInventoryData(); }); 
                } 
            });

            document.getElementById('add-to-cart-button').addEventListener('click', addToCart);
            document.getElementById('sale-product-select').addEventListener('change', updateSalePriceInput);
            document.getElementById('cart-items-container').addEventListener('click', e => { if (e.target.classList.contains('remove-from-cart')) { const index = parseInt(e.target.dataset.index); state.cart.splice(index, 1); renderCart(); } });
            document.getElementById('record-sale-button').addEventListener('click', async () => { const result = await api.recordSale(state.cart); showModal(result.success ? 'Success' : 'Error', result.message, () => {}, false); if (result.success) { state.cart = []; renderCart(); refreshSalesData(); } });
            document.getElementById('filter-sales-button').addEventListener('click', () => { const date = document.getElementById('filter-date').value; const month = document.getElementById('filter-month').value; refreshSalesData(date, month); });
            document.getElementById('clear-filter-button').addEventListener('click', () => { document.getElementById('filter-date').value = ''; document.getElementById('filter-month').value = ''; refreshSalesData(); });
            document.getElementById('sales-table').addEventListener('click', e => { if (e.target.classList.contains('delete-sale')) { const saleId = e.target.dataset.saleId; showModal('Delete Sale', 'Are you sure? This will restore stock for all items sold.', async () => { await api.deleteSale(saleId); refreshSalesData(); }); } });
            document.getElementById('next-page-button').addEventListener('click', () => refreshInventoryData('next'));
            document.getElementById('prev-page-button').addEventListener('click', () => refreshInventoryData('prev'));
            document.getElementById('generate-store-link-button').addEventListener('click', () => { if (state.uid) { const storeUrl = `${window.location.protocol}//${window.location.host}/store/${state.uid}`; showModal('Your Public Store Link', `You can share this link with your customers: <input type="text" value="${storeUrl}" readonly class="w-full mt-2 p-2 border rounded bg-gray-100" onclick="this.select()">`, null, false); modal.cancelBtn.textContent = 'Close'; } else { showModal('Error', 'Could not generate link. Please log in again.', null, false); } });

            document.getElementById('manage-types-button').addEventListener('click', showTypesModal);
            typesModal.addBtn.addEventListener('click', async () => {
                const name = typesModal.input.value.trim();
                if (!name) { typesModal.error.textContent = "Please enter a type name."; typesModal.error.classList.remove('hidden'); return; }
                const result = await api.addType(name);
                if (result.success) { typesModal.input.value = ''; typesModal.error.classList.add('hidden'); await refreshTypesModalList(); await populateTypesDropdown(); } else { typesModal.error.textContent = result.message; typesModal.error.classList.remove('hidden'); }
            });
            typesModal.list.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-type-btn')) {
                    const typeId = e.target.dataset.id;
                    showModal('Delete Type', 'Are you sure? This will not remove the type from existing products, but it will no longer be an option.', async () => { await api.deleteType(typeId); await refreshTypesModalList(); await populateTypesDropdown(); });
                }
            });
            
            document.getElementById('add-contact-button').addEventListener('click', () => { const nameInput = document.getElementById('new-contact-name'); const urlInput = document.getElementById('new-contact-url'); const name = nameInput.value.trim(); const url = urlInput.value.trim(); if (name && url) { try { new URL(url); if (!state.storeSettings.contacts) { state.storeSettings.contacts = []; } state.storeSettings.contacts.push({ name, url }); renderContacts(); nameInput.value = ''; urlInput.value = ''; } catch (_) { showModal('Error', 'Please enter a valid URL (e.g., https://example.com)', null, false); } } else { showModal('Error', 'Please enter both a name and a URL for the contact.', null, false); } });
            document.getElementById('contacts-container').addEventListener('click', (e) => { if (e.target.classList.contains('remove-contact-btn')) { const index = parseInt(e.target.dataset.index, 10); state.storeSettings.contacts.splice(index, 1); renderContacts(); } });
            document.getElementById('save-store-settings-button').addEventListener('click', async () => { const saveButton = document.getElementById('save-store-settings-button'); const originalButtonText = saveButton.textContent; const storeName = document.getElementById('store-name-input').value.trim(); saveButton.disabled = true; saveButton.textContent = 'Saving...'; try { const settingsToSave = { store_name: storeName, contacts: state.storeSettings.contacts || [] }; const result = await api.updateStoreSettings(settingsToSave); showModal(result.success ? 'Success' : 'Error', result.message, null, false); if (result.success) { await loadStoreSettings(); } } catch (error) { showModal('Error', 'An unexpected error occurred while saving.', null, false); } finally { saveButton.disabled = false; saveButton.textContent = originalButtonText; } });
            
            showPage('splash-screen');
        });
    </script>
</body>
</html>

